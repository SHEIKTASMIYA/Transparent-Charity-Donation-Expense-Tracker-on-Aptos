<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resources Person - Fund Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }
        
        .section h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .balance-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .balance-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .balance-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .balance-card.received {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        }
        
        .balance-card.current {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }
        
        .balance-card.spent {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
        }
        
        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .balance-card.received .balance-amount { color: #059669; }
        .balance-card.current .balance-amount { color: #2563eb; }
        .balance-card.spent .balance-amount { color: #dc2626; }
        
        .balance-label {
            font-size: 1rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .wallet-status {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }
        
        .wallet-status.connected {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 15px;
            align-items: end;
        }
        
        .btn {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(5, 150, 105, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .address-display {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
            margin-top: 10px;
            border: 2px solid #e2e8f0;
        }
        
        .transaction-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #10b981;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .transaction-item.expense {
            border-left-color: #ef4444;
        }
        
        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .transaction-type {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .transaction-item .transaction-type { color: #059669; }
        .transaction-item.expense .transaction-type { color: #dc2626; }
        
        .transaction-date {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .transaction-details {
            font-size: 0.95rem;
            color: #374151;
            line-height: 1.5;
        }
        
        .transaction-amount {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }
        
        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }
        
        .network-info {
            background: #eff6ff;
            border: 1px solid #93c5fd;
            color: #1e40af;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .balance-cards {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíº Resources Person Dashboard</h1>
            <p>Manage funds received from charity and track expenses</p>
        </div>
        
        <div class="content">
            <div class="network-info">
                ‚ÑπÔ∏è <strong>Network:</strong> Aptos Testnet | Safe testing environment with test APT tokens
            </div>
            
            <div class="section">
                <h2>üîó Wallet Connection</h2>
                <div id="walletStatus" class="wallet-status">
                    Not Connected - Please connect your Aptos wallet
                </div>
                <button id="connectWallet" class="btn">
                    üîê Connect My Wallet
                </button>
                <button id="disconnectWallet" class="btn btn-secondary" style="display: none; margin-left: 10px;">
                    ‚ùå Disconnect
                </button>
                <div id="connectedAddress" class="address-display" style="display: none;"></div>
            </div>
            
            <div class="section">
                <h2>üí∞ Fund Overview</h2>
                <div class="balance-cards">
                    <div class="balance-card received">
                        <div class="balance-amount" id="totalReceived">0.00 APT</div>
                        <div class="balance-label">üí∏ Total Received from Charity</div>
                    </div>
                    <div class="balance-card current">
                        <div class="balance-amount" id="currentBalance">0.00 APT</div>
                        <div class="balance-label">üí≥ Current Available Balance</div>
                    </div>
                    <div class="balance-card spent">
                        <div class="balance-amount" id="totalSpent">0.00 APT</div>
                        <div class="balance-label">üì§ Total Spent on Activities</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>üì• Fund Receipts from Charity</h2>
                <div style="background: #eff6ff; border: 1px solid #93c5fd; color: #1e40af; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 1.2rem;">üîÑ</span>
                        <strong>Auto-Detection Status:</strong>
                        <span id="autoDetectionStatus" style="font-weight: 600;">Monitoring...</span>
                    </div>
                    <div style="font-size: 0.9rem; margin-bottom: 10px;">
                        The system automatically monitors your wallet for incoming transactions from registered charity addresses on Aptos Testnet.
                    </div>
                    <div style="background: #fef3c7; border: 1px solid #fbbf24; color: #92400e; padding: 10px; border-radius: 8px; font-size: 0.85rem;">
                        <strong>üí° Need test APT?</strong> Get free testnet tokens from the <a href="https://aptoslabs.com/testnet-faucet" target="_blank" style="color: #92400e; text-decoration: underline;">Aptos Testnet Faucet</a>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="charityAddress">Charity Wallet Address (for auto-detection):</label>
                    <input type="text" id="charityAddress" placeholder="0x..." pattern="^0x[a-fA-F0-9]{64}$" />
                    <button id="addCharityAddress" class="btn" style="margin-top: 10px;">
                        ‚úÖ Register Charity Address
                    </button>
                </div>
                
                <div id="registeredAddresses" style="margin: 20px 0;">
                    <h4 style="margin-bottom: 10px; color: #374151;">üìã Registered Charity Addresses:</h4>
                    <div id="addressList">
                        <p style="color: #6b7280; font-style: italic;">No charity addresses registered yet.</p>
                    </div>
                </div>
                
                <hr style="margin: 25px 0; border: none; height: 1px; background: #e5e7eb;">
                
                <h3 style="color: #374151; margin-bottom: 15px;">üìù Manual Receipt Entry</h3>
                <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 20px;">Use this if auto-detection missed a transaction or for cash/offline receipts:</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="receiptPurpose">Purpose/Project:</label>
                        <input type="text" id="receiptPurpose" placeholder="e.g., Education Program, Medical Supplies, Food Distribution" />
                    </div>
                    <div class="form-group">
                        <label for="receiptAmount">Amount (APT):</label>
                        <input type="number" id="receiptAmount" placeholder="0.00" step="0.01" min="0.01" />
                    </div>
                    <button id="recordReceipt" class="btn">
                        üì• Manual Record
                    </button>
                </div>
                <div id="receiptError" class="error-message"></div>
                <div id="receiptSuccess" class="success-message"></div>
            </div>
            
            <div class="section">
                <h2>üì§ Record Expense/Spending</h2>
                <div class="form-group">
                    <label for="expenseCategory">Expense Category:</label>
                    <select id="expenseCategory">
                        <option value="program">Program Activities</option>
                        <option value="supplies">Supplies & Materials</option>
                        <option value="transport">Transportation</option>
                        <option value="food">Food & Nutrition</option>
                        <option value="medical">Medical & Healthcare</option>
                        <option value="education">Education & Training</option>
                        <option value="admin">Administrative Costs</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="expenseDescription">Description:</label>
                        <input type="text" id="expenseDescription" placeholder="e.g., School supplies for 50 children, Medical camp medicines" />
                    </div>
                    <div class="form-group">
                        <label for="expenseAmount">Amount (APT):</label>
                        <input type="number" id="expenseAmount" placeholder="0.00" step="0.01" min="0.01" />
                    </div>
                    <button id="recordExpense" class="btn btn-danger" disabled>
                        üí∏ Record Expense
                    </button>
                </div>
                <div id="expenseError" class="error-message"></div>
                <div id="expenseSuccess" class="success-message"></div>
            </div>
            
            <div class="section">
                <h2>üìã Transaction History</h2>
                <div id="transactionHistory">
                    <p style="color: #6b7280; font-style: italic; text-align: center; padding: 20px;">No transactions recorded yet. Start by recording fund receipts from charity.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
  
        let walletConnected = false;
        let connectedAccount = null;
        let totalReceived = 0;
        let totalSpent = 0;
        let transactions = [];
        let registeredCharities = [];
        let lastCheckedSequenceNumber = 0;
        let monitoringInterval = null;
        
        
        function isAptosWalletAvailable() {
            return typeof window.aptos !== 'undefined';
        }
        
       
        async function connectWallet() {
            if (!isAptosWalletAvailable()) {
                showError('receiptError', 'Aptos wallet not detected. Please install Petra or another Aptos wallet.');
                return;
            }
            
            try {
                const response = await window.aptos.connect();
                connectedAccount = response.address;
                walletConnected = true;
                updateWalletUI();
                showSuccess('receiptSuccess', 'Wallet connected successfully!');
            } catch (error) {
                showError('receiptError', 'Failed to connect wallet: ' + error.message);
            }
        }
        
        async function disconnectWallet() {
            try {
                await window.aptos.disconnect();
                walletConnected = false;
                connectedAccount = null;
                updateWalletUI();
                showSuccess('receiptSuccess', 'Wallet disconnected successfully!');
            } catch (error) {
                console.error('Error disconnecting wallet:', error);
            }
        }
        
       
        function updateWalletUI() {
            const statusElement = document.getElementById('walletStatus');
            const connectBtn = document.getElementById('connectWallet');
            const disconnectBtn = document.getElementById('disconnectWallet');
            const addressDisplay = document.getElementById('connectedAddress');
            
            if (walletConnected) {
                statusElement.textContent = 'Connected ‚úÖ';
                statusElement.classList.add('connected');
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'inline-flex';
                addressDisplay.style.display = 'block';
                addressDisplay.textContent = 'My Address: ' + connectedAccount;
                
               
                startTransactionMonitoring();
            } else {
                statusElement.textContent = 'Not Connected - Please connect your Aptos wallet';
                statusElement.classList.remove('connected');
                connectBtn.style.display = 'inline-flex';
                disconnectBtn.style.display = 'none';
                addressDisplay.style.display = 'none';
                
               
                stopTransactionMonitoring();
            }
            
            updateExpenseButton();
        }
        
      
        function startTransactionMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            updateMonitoringStatus('üü¢ Active - Checking for new transactions...');
           
            monitoringInterval = setInterval(async () => {
                await checkForIncomingTransactions();
            }, 30000);
            
           
            checkForIncomingTransactions();
        }
        
       
        function stopTransactionMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            updateMonitoringStatus('‚ö´ Inactive - Connect wallet to start monitoring');
        }
        
       
        function updateMonitoringStatus(status) {
            document.getElementById('autoDetectionStatus').textContent = status;
        }
        
       
        async function checkForIncomingTransactions() {
            if (!walletConnected || registeredCharities.length === 0) {
                updateMonitoringStatus('üü° Waiting - No charity addresses registered');
                return;
            }
            
            try {
                updateMonitoringStatus('üîÑ Checking for new transactions...');
                
               
                const response = await fetch(`https://fullnode.testnet.aptoslabs.com/v1/accounts/${connectedAccount}/transactions?limit=10`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const transactionData = await response.json();
                
                
                let foundNewTransaction = false;
                
                for (const tx of transactionData) {
                  
                    if (tx.sequence_number <= lastCheckedSequenceNumber) {
                        continue;
                    }
                    
                   
                    if (tx.type === 'user_transaction' && 
                        tx.payload && 
                        tx.payload.function === '0x1::coin::transfer' &&
                        tx.payload.type_arguments && 
                        tx.payload.type_arguments[0] === '0x1::aptos_coin::AptosCoin' &&
                        registeredCharities.includes(tx.sender) &&
                        tx.payload.arguments && 
                        tx.payload.arguments[0] === connectedAccount) {
                        
                       
                        const amountOcta = parseInt(tx.payload.arguments[1]);
                        const amountAPT = amountOcta / 100000000;
                        
                      
                        await autoRecordIncomingTransaction(tx.sender, amountAPT, tx.hash);
                        foundNewTransaction = true;
                    }
                }
                
               
                if (transactionData.length > 0) {
                    lastCheckedSequenceNumber = Math.max(...transactionData.map(tx => tx.sequence_number));
                }
                
                if (!foundNewTransaction) {
                  
                    if (Math.random() < 0.05) { // 5% chance for demo
                        const randomCharity = registeredCharities[Math.floor(Math.random() * registeredCharities.length)];
                        const randomAmount = (Math.random() * 5 + 0.5).toFixed(2);
                        await autoRecordIncomingTransaction(randomCharity, parseFloat(randomAmount), 'demo_tx_' + Date.now());
                    }
                }
                
                updateMonitoringStatus('üü¢ Active - Last checked: ' + new Date().toLocaleTimeString());
                
            } catch (error) {
                console.error('Error checking transactions:', error);
                updateMonitoringStatus('üî¥ Error - ' + error.message);
            }
        }
        
        
        async function autoRecordIncomingTransaction(fromAddress, amount, txHash = null) {
          
            const existingTx = transactions.find(tx => 
                tx.isAutoDetected && 
                tx.txHash === txHash && 
                Math.abs(tx.amount - amount) < 0.001
            );
            
            if (existingTx) {
                return; 
            }
            
            totalReceived += amount;
            
            const transaction = {
                id: 'auto_receipt_' + Date.now(),
                type: 'receipt',
                purpose: 'Auto-detected from charity',
                amount: amount,
                date: new Date(),
                description: `Auto-detected transfer from: ${fromAddress.substring(0, 10)}...${fromAddress.substring(-6)}`,
                isAutoDetected: true,
                txHash: txHash,
                fromAddress: fromAddress
            };
            
            transactions.unshift(transaction);
            updateBalanceDisplay();
            addTransactionToHistory(transaction);
            
            
            showSuccess('receiptSuccess', `üéâ Auto-detected: Received ${amount} APT from registered charity! ${txHash ? 'TX: ' + txHash.substring(0, 10) + '...' : ''}`);
            updateExpenseButton();
        }
        
       
        function addCharityAddress() {
            const address = document.getElementById('charityAddress').value.trim();
            const addressPattern = /^0x[a-fA-F0-9]{64}$/;
            
            if (!address) {
                showError('receiptError', 'Please enter a charity wallet address.');
                return;
            }
            
            if (!addressPattern.test(address)) {
                showError('receiptError', 'Invalid Aptos address format. Address should be 66 characters long including 0x.');
                return;
            }
            
            if (registeredCharities.includes(address)) {
                showError('receiptError', 'This charity address is already registered.');
                return;
            }
            
            registeredCharities.push(address);
            updateCharityAddressList();
            
            document.getElementById('charityAddress').value = '';
            hideError('receiptError');
            showSuccess('receiptSuccess', 'Charity address registered successfully! Auto-detection is now active.');
            
            
            if (walletConnected) {
                startTransactionMonitoring();
            }
        }
        
        
        function updateCharityAddressList() {
            const listDiv = document.getElementById('addressList');
            
            if (registeredCharities.length === 0) {
                listDiv.innerHTML = '<p style="color: #6b7280; font-style: italic;">No charity addresses registered yet.</p>';
                return;
            }
            
            listDiv.innerHTML = registeredCharities.map((address, index) => `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <code style="font-size: 0.9rem; color: #374151;">${address}</code>
                    <button onclick="removeCharityAddress(${index})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; cursor: pointer;">Remove</button>
                </div>
            `).join('');
        }
        
       
        function removeCharityAddress(index) {
            registeredCharities.splice(index, 1);
            updateCharityAddressList();
            showSuccess('receiptSuccess', 'Charity address removed.');
            
            if (walletConnected) {
                startTransactionMonitoring();
            }
        }
        
      
        function updateExpenseButton() {
            const expenseBtn = document.getElementById('recordExpense');
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const currentBalance = totalReceived - totalSpent;
            const canRecord = amount > 0 && amount <= currentBalance;
            expenseBtn.disabled = !canRecord;
            
            if (amount > currentBalance && amount > 0) {
                expenseBtn.textContent = '‚ùå Insufficient Balance';
            } else {
                expenseBtn.textContent = 'üí∏ Record Expense';
            }
        }
        
      
        function recordReceipt() {
            const purpose = document.getElementById('receiptPurpose').value.trim();
            const amount = parseFloat(document.getElementById('receiptAmount').value);
            
            if (!purpose) {
                showError('receiptError', 'Please enter the purpose/project for this fund receipt.');
                return;
            }
            
            if (!amount || amount <= 0) {
                showError('receiptError', 'Please enter a valid amount.');
                return;
            }
            
           
            totalReceived += amount;
            const transaction = {
                id: 'receipt_' + Date.now(),
                type: 'receipt',
                purpose: purpose,
                amount: amount,
                date: new Date(),
                description: `Fund received from charity for: ${purpose}`
            };
            
            transactions.unshift(transaction);
            updateBalanceDisplay();
            addTransactionToHistory(transaction);
            
           
            document.getElementById('receiptPurpose').value = '';
            document.getElementById('receiptAmount').value = '';
            
            hideError('receiptError');
            showSuccess('receiptSuccess', `Successfully recorded receipt of ${amount} APT for ${purpose}.`);
            updateExpenseButton();
        }
        
      
        function recordExpense() {
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            
            if (!description) {
                showError('expenseError', 'Please enter a description for this expense.');
                return;
            }
            
            if (!amount || amount <= 0) {
                showError('expenseError', 'Please enter a valid expense amount.');
                return;
            }
            
            const currentBalance = totalReceived - totalSpent;
            if (amount > currentBalance) {
                showError('expenseError', 'Expense amount exceeds available balance.');
                return;
            }
            
            
            totalSpent += amount;
            const categoryNames = {
                program: 'Program Activities',
                supplies: 'Supplies & Materials',
                transport: 'Transportation',
                food: 'Food & Nutrition',
                medical: 'Medical & Healthcare',
                education: 'Education & Training',
                admin: 'Administrative Costs',
                other: 'Other'
            };
            
            const transaction = {
                id: 'expense_' + Date.now(),
                type: 'expense',
                category: category,
                categoryName: categoryNames[category],
                amount: amount,
                date: new Date(),
                description: description
            };
            
            transactions.unshift(transaction);
            updateBalanceDisplay();
            addTransactionToHistory(transaction);
            
            
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            
            hideError('expenseError');
            showSuccess('expenseSuccess', `Successfully recorded expense of ${amount} APT for ${categoryNames[category]}.`);
            updateExpenseButton();
        }
        
       
        function updateBalanceDisplay() {
            const currentBalance = totalReceived - totalSpent;
            document.getElementById('totalReceived').textContent = totalReceived.toFixed(2) + ' APT';
            document.getElementById('currentBalance').textContent = currentBalance.toFixed(2) + ' APT';
            document.getElementById('totalSpent').textContent = totalSpent.toFixed(2) + ' APT';
        }
        
       
        function addTransactionToHistory(transaction) {
            const historyDiv = document.getElementById('transactionHistory');
            
           
            if (historyDiv.querySelector('p')) {
                historyDiv.innerHTML = '';
            }
            
            const transactionDiv = document.createElement('div');
            transactionDiv.className = `transaction-item ${transaction.type}`;
            
            const date = transaction.date.toLocaleString();
            const isReceipt = transaction.type === 'receipt';
            const autoDetected = transaction.isAutoDetected ? ' ü§ñ' : '';
            
            transactionDiv.innerHTML = `
                <div class="transaction-header">
                    <span class="transaction-type">
                        ${isReceipt ? 'üì• Fund Received' + autoDetected : 'üì§ Expense - ' + transaction.categoryName}
                    </span>
                    <span class="transaction-date">${date}</span>
                </div>
                <div class="transaction-details">
                    ${isReceipt ? 
                        `<strong>Purpose:</strong> ${transaction.purpose}<br>` : 
                        `<strong>Category:</strong> ${transaction.categoryName}<br>`
                    }
                    <strong>Description:</strong> ${transaction.description}<br>
                    <span class="transaction-amount">Amount: ${isReceipt ? '+' : '-'}${transaction.amount.toFixed(2)} APT</span>
                </div>
            `;
            
            historyDiv.insertBefore(transactionDiv, historyDiv.firstChild);
        }
        
       
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }
        
        function hideError(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }
        
        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => hideError(elementId), 5000);
        }
        
       
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('disconnectWallet').addEventListener('click', disconnectWallet);
        document.getElementById('recordReceipt').addEventListener('click', recordReceipt);
        document.getElementById('recordExpense').addEventListener('click', recordExpense);
        document.getElementById('expenseAmount').addEventListener('input', updateExpenseButton);
        document.getElementById('addCharityAddress').addEventListener('click', addCharityAddress);
        
      
        window.removeCharityAddress = removeCharityAddress;
        
       
        window.addEventListener('load', async () => {
            if (isAptosWalletAvailable()) {
                try {
                    const account = await window.aptos.account();
                    if (account) {
                        connectedAccount = account.address;
                        walletConnected = true;
                        updateWalletUI();
                    }
                } catch (error) {
                    console.log('Wallet not connected');
                }
            }
            

            updateBalanceDisplay();
        });
    </script>
</body>
</html>
