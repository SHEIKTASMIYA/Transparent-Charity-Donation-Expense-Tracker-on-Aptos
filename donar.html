<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petra Wallet Donation Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .wallet-info {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border-left: 4px solid #667eea;
        }

        .wallet-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .wallet-status {
            font-size: 1.2rem;
            font-weight: bold;
            color: #28a745;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 0.9rem;
            color: #666;
            word-break: break-all;
        }

        .charity-spending {
            background: #e8f5e8;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border-left: 4px solid #28a745;
        }

        .charity-spending h3 {
            color: #155724;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .spending-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .spending-card {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #d4edda;
        }

        .spending-amount {
            font-size: 1.3rem;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 0.5rem;
        }

        .spending-category {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .spending-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .spending-item {
            background: white;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border: 1px solid #d4edda;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .spending-details {
            flex: 1;
            min-width: 200px;
        }

        .spending-title {
            font-weight: bold;
            color: #155724;
            margin-bottom: 0.2rem;
        }

        .spending-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.2rem;
        }

        .spending-date {
            font-size: 0.8rem;
            color: #888;
        }

        .spending-cost {
            font-weight: bold;
            color: #dc3545;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        .status {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .charity-info {
            background: #e8f5e8;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #28a745;
        }

        .charity-info h3 {
            color: #155724;
            margin-bottom: 0.5rem;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        .transaction-history {
            background: #fff9e6;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border-left: 4px solid #ffc107;
        }

        .transaction-history h3 {
            color: #856404;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .total-donated {
            font-size: 1.2rem;
            font-weight: bold;
            color: #155724;
            background: #d4edda;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .transaction-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .transaction-item {
            background: white;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .transaction-details {
            flex: 1;
            min-width: 200px;
        }

        .transaction-amount {
            font-weight: bold;
            color: #28a745;
            font-size: 1.1rem;
        }

        .transaction-address {
            font-family: monospace;
            font-size: 0.8rem;
            color: #666;
            margin: 0.2rem 0;
        }

        .transaction-time {
            font-size: 0.8rem;
            color: #888;
        }

        .transaction-hash {
            font-family: monospace;
            font-size: 0.7rem;
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
        }

        .transaction-hash:hover {
            color: #0056b3;
        }

        .no-transactions {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
        }

        .clear-history-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .clear-history-btn:hover {
            background: #c82333;
        }

        .history-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .network-info {
            background: #fff3cd;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 4px solid #ffc107;
            font-size: 0.9rem;
        }

        .impact-metrics {
            background: #f0f8ff;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border-left: 4px solid #007bff;
        }

        .impact-metrics h3 {
            color: #004085;
            margin-bottom: 1rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .metric-card {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #b8daff;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 0.3rem;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .persistent-notice {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }

        .export-import-controls {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .export-btn, .import-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .export-btn:hover, .import-btn:hover {
            background: #0056b3;
        }

        .import-file {
            display: none;
        }

        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }
            
            .spending-summary {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .transaction-history h3 {
                flex-direction: column;
                align-items: stretch;
            }
            
            .history-controls {
                justify-content: space-between;
            }

            .export-import-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Charity Impact Tracker</h1>
            <p>Track how your donations create real change</p>
        </div>

        <div class="persistent-notice">
            üíæ <strong>Persistent Storage:</strong> Your donation history is now saved permanently in your browser and will persist across sessions!
        </div>

        <div id="connectSection">
            <div class="network-info">
                ‚ö†Ô∏è <strong>Important:</strong> This app uses Aptos Testnet. Make sure your Petra wallet is set to Testnet and you have testnet APT tokens.
                <br><small>Get free testnet APT from: <a href="https://aptoslabs.com/testnet-faucet" target="_blank">https://aptoslabs.com/testnet-faucet</a></small>
            </div>
            <button class="btn btn-primary" onclick="connectWallet()">
                Connect Petra Wallet
            </button>
        </div>

        <div id="walletSection" class="hidden">
            <div class="wallet-info">
                <div class="wallet-display">
                    <div>
                        <div class="wallet-status">‚úÖ Wallet Connected</div>
                        <div>Ready to make impact</div>
                    </div>
                </div>
                <div class="wallet-address">
                    <strong>Your Address:</strong> <span id="walletAddress">Not connected</span>
                </div>
            </div>

            <div class="impact-metrics">
                <h3>üìä Your Impact So Far</h3>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="totalDonationsMetric">0</div>
                        <div class="metric-label">Total Donations</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="totalAmountMetric">0 APT</div>
                        <div class="metric-label">Amount Donated</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="livesImpactedMetric">0</div>
                        <div class="metric-label">Lives Impacted</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="projectsFundedMetric">0</div>
                        <div class="metric-label">Projects Funded</div>
                    </div>
                </div>
            </div>

            <div class="charity-spending">
                <h3>
                    üí∞ How Your Donations Are Being Used
                    <div>
                        <button class="refresh-btn" onclick="refreshSpendingData()" title="Refresh spending data">
                            üîÑ Update
                        </button>
                    </div>
                </h3>
                
                <div class="spending-summary">
                    <div class="spending-card">
                        <div class="spending-amount" id="medicalSpending">45.2 APT</div>
                        <div class="spending-category">Medical Aid</div>
                    </div>
                    <div class="spending-card">
                        <div class="spending-amount" id="educationSpending">32.8 APT</div>
                        <div class="spending-category">Education</div>
                    </div>
                    <div class="spending-card">
                        <div class="spending-amount" id="foodSpending">28.5 APT</div>
                        <div class="spending-category">Food Security</div>
                    </div>
                    <div class="spending-card">
                        <div class="spending-amount" id="housingSpending">19.3 APT</div>
                        <div class="spending-category">Housing</div>
                    </div>
                </div>

                <div class="spending-list" id="spendingList">
                   <!-- Spending items will be populated by JavaScript -->
                </div>
            </div>

            <div class="charity-info">
                <h3>üè• Charity Information</h3>
                <p><strong>Children's Hope Foundation</strong></p>
                <p class="wallet-address">0xd42f5bc06353ac78ccebb345c10bf623b564ad4a9ff8c7fef58447e425f63763</p>
                <p><small><em>‚ö†Ô∏è Replace with real charity address before sending</em></small></p>
            </div>

            <div class="transaction-history">
                <h3>
                    üìä Your Donation History
                    <div class="history-controls">
                        <span class="total-donated" id="totalDonated">Total: 0 APT</span>
                        <button class="clear-history-btn" onclick="clearHistory()" title="Clear donation history">
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </h3>

                <div class="export-import-controls">
                    <button class="export-btn" onclick="exportHistory()" title="Export donation history">
                        üìÅ Export History
                    </button>
                    <button class="import-btn" onclick="document.getElementById('importFile').click()" title="Import donation history">
                        üìÇ Import History
                    </button>
                    <input type="file" id="importFile" class="import-file" accept=".json" onchange="importHistory(event)">
                </div>

                <div class="transaction-list" id="transactionList">
                    <div class="no-transactions">
                        No donations made yet. Your charity donations will appear here.
                    </div>
                </div>
            </div>

            <form id="donationForm">
                <div class="form-group">
                    <label for="recipientAddress">Charity Wallet Address</label>
                    <input 
                        type="text" 
                        id="recipientAddress" 
                        placeholder="0x..." 
                        value="0xd42f5bc06353ac78ccebb345c10bf623b564ad4a9ff8c7fef58447e425f63763"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="amount">Amount (APT)</label>
                    <input 
                        type="number" 
                        id="amount" 
                        placeholder="0.01" 
                        min="0.001" 
                        step="0.001" 
                        required
                    >
                </div>

                <button type="submit" class="btn btn-primary" id="sendBtn">
                    Send Donation
                </button>
            </form>

            <button class="btn btn-secondary" onclick="disconnectWallet()">
                Disconnect Wallet
            </button>
        </div>

        <div id="status"></div>
    </div>

    <script>
        let currentAccount = null;
        let donationHistory = [];
        let charitySpendingData = [];
        let charityWalletSpending = {};
        const STORAGE_PREFIX = 'charity_donation_';
        const CHARITY_SPENDING_PREFIX = 'charity_spending_';
        const GLOBAL_STATS_KEY = 'charity_global_stats';
        const spendingCategories = {
            medical: [
                { title: "Medical Supplies Purchase", description: "Emergency medical kits for rural villages" },
                { title: "Vaccination Campaign", description: "Community health immunization drive" },
                { title: "Medicine Distribution", description: "Essential medicines for chronic patients" },
                { title: "Health Checkup Program", description: "Free health screening for elderly" }
            ],
            education: [
                { title: "School Construction Materials", description: "Building materials for new classroom" },
                { title: "Teacher Training Program", description: "Professional development for local educators" },
                { title: "Educational Supplies", description: "Books, notebooks, and stationery for students" },
                { title: "Computer Lab Setup", description: "Digital literacy program equipment" }
            ],
            food: [
                { title: "Food Distribution Program", description: "Monthly food packages for families" },
                { title: "Community Kitchen", description: "Daily meals for homeless individuals" },
                { title: "Child Nutrition Program", description: "Nutritious meals for school children" },
                { title: "Emergency Food Relief", description: "Food assistance during crisis" }
            ],
            housing: [
                { title: "Emergency Shelter Setup", description: "Temporary housing for displaced families" },
                { title: "Home Renovation", description: "Repair work for damaged homes" },
                { title: "Housing Materials", description: "Construction supplies for new homes" },
                { title: "Shelter Maintenance", description: "Upkeep of community shelters" }
            ]
        };
        const APTOS_NODE_URL = 'https://fullnode.testnet.aptoslabs.com/v1';
        function setLocalStorage(key, value) {
            try {
                const serializedValue = JSON.stringify(value);
                localStorage.setItem(key, serializedValue);
                console.log(`Saved to localStorage: ${key}`);
                return true;
            } catch (error) {
                console.error('Failed to save to localStorage:', error);
                showStatus('Warning: Unable to save data permanently. Changes may be lost on page refresh.', 'error');
                return false;
            }
        }

        function getLocalStorage(key, defaultValue = null) {
            try {
                const item = localStorage.getItem(key);
                if (item === null) {
                    return defaultValue;
                }
                return JSON.parse(item);
            } catch (error) {
                console.error('Failed to retrieve from localStorage:', error);
                return defaultValue;
            }
        }

        function removeLocalStorage(key) {
            try {
                localStorage.removeItem(key);
                console.log(`Removed from localStorage: ${key}`);
                return true;
            } catch (error) {
                console.error('Failed to remove from localStorage:', error);
                return false;
            }
        }
        function isLocalStorageAvailable() {
            try {
                const test = '__localStorage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (error) {
                return false;
            }
        }
        function initializeStorage() {
            if (!isLocalStorageAvailable()) {
                showStatus('Warning: Local storage is not available. Donation history will not persist across sessions.', 'error');
                return false;
            }
            return true;
        }
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            const message = error.message || error.toString() || 'Unknown error occurred';
            showStatus(`${context} failed: ${message}`, 'error');
        }

        async function connectWallet() {
            try {
                if (!window.aptos) {
                    showStatus('Please install Petra Wallet extension from Chrome Web Store', 'error');
                    return;
                }
                showStatus('Connecting to Petra Wallet...', 'info');
                const response = await window.aptos.connect();
                
                if (!response || !response.address) {
                    throw new Error('Failed to get wallet address');
                }

                currentAccount = response;
                document.getElementById('walletAddress').textContent = currentAccount.address;
                document.getElementById('connectSection').classList.add('hidden');
                document.getElementById('walletSection').classList.remove('hidden');

                loadDonationHistory();
                updateDonationDisplay();
                updateImpactMetrics();
                loadSpendingData();
                showStatus('Successfully connected to Petra Wallet!', 'success');
                
                console.log('Connected account:', currentAccount);

            } catch (error) {
                handleError(error, 'Wallet connection');
                currentAccount = null;
            }
        }

        async function disconnectWallet() {
            try {
                if (window.aptos && window.aptos.disconnect) {
                    await window.aptos.disconnect();
                }
                
                currentAccount = null;
                donationHistory = [];
                
                document.getElementById('connectSection').classList.remove('hidden');
                document.getElementById('walletSection').classList.add('hidden');
                document.getElementById('walletAddress').textContent = 'Not connected';
                
                updateDonationDisplay();
                updateImpactMetrics();
                showStatus('Wallet disconnected', 'info');

            } catch (error) {
                handleError(error, 'Wallet disconnection');
            }
        }

        function loadSpendingData() {
            charitySpendingData = [];
            const charityAddresses = [...new Set(donationHistory.map(tx => tx.recipient))];
            if (charityAddresses.length === 0) {
                updateSpendingDisplay();
                return;
            }
            charityAddresses.forEach(address => {
                const spendingKey = `${CHARITY_SPENDING_PREFIX}${address}`;
                const savedSpending = getLocalStorage(spendingKey, []);
                charitySpendingData.push(...savedSpending);
            });
            charitySpendingData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            updateSpendingDisplay();
        }

        function generateSpendingForDonation(donation) {
            const charityAddress = donation.recipient;
            const donationAmount = parseFloat(donation.amount);
            const numSpending = Math.min(4, Math.max(2, Math.floor(donationAmount / 5) + 1));
            const spendingItems = [];
            let remainingAmount = donationAmount;
            const categories = Object.keys(spendingCategories);
            
            for (let i = 0; i < numSpending && remainingAmount > 0.1; i++) {
                const category = categories[Math.floor(Math.random() * categories.length)];
                const activities = spendingCategories[category];
                const activity = activities[Math.floor(Math.random() * activities.length)];
                const maxSpend = Math.min(remainingAmount, donationAmount * 0.6);
                const minSpend = Math.min(remainingAmount * 0.2, maxSpend);
                const spendAmount = Math.random() * (maxSpend - minSpend) + minSpend;
                const spendingDate = new Date(new Date(donation.timestamp).getTime() + (i + 1) * 24 * 60 * 60 * 1000);
                const spending = {
                    id: `${donation.hash}_${i}`,
                    title: activity.title,
                    description: activity.description,
                    amount: parseFloat(spendAmount.toFixed(3)),
                    category: category,
                    charityAddress: charityAddress,
                    donationHash: donation.hash,
                    timestamp: spendingDate.toISOString(),
                    date: spendingDate.toLocaleDateString(),
                    time: spendingDate.toLocaleTimeString()
                };
                
                spendingItems.push(spending);
                remainingAmount -= spendAmount;
            }
            const spendingKey = `${CHARITY_SPENDING_PREFIX}${charityAddress}`;
            const existingSpending = getLocalStorage(spendingKey, []);
            const newSpending = spendingItems.filter(item => 
                !existingSpending.some(existing => existing.id === item.id)
            );
            
            if (newSpending.length > 0) {
                const updatedSpending = [...existingSpending, ...newSpending];
                setLocalStorage(spendingKey, updatedSpending);
                loadSpendingData();
                
                return newSpending.length;
            }
            
            return 0;
        }

        function refreshSpendingData() {
            if (donationHistory.length === 0) {
                showStatus('No donations found. Make a donation first to see spending data.', 'info');
                return;
            }

            showStatus('Checking for new charity spending updates...', 'info');
            setTimeout(() => {
                const recentDonations = donationHistory.filter(donation => {
                    const donationDate = new Date(donation.timestamp);
                    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    return donationDate > sevenDaysAgo;
                });

                let newSpendingCount = 0;
                recentDonations.forEach(donation => {
                    if (Math.random() < 0.3) {
                        const charityAddress = donation.recipient;
                        const categories = Object.keys(spendingCategories);
                        const category = categories[Math.floor(Math.random() * categories.length)];
                        const activities = spendingCategories[category];
                        const activity = activities[Math.floor(Math.random() * activities.length)];
                        
                        const spendAmount = Math.random() * (parseFloat(donation.amount) * 0.4) + 1;
                        const spending = {
                            id: `refresh_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            title: activity.title,
                            description: activity.description + " (Recent update)",
                            amount: parseFloat(spendAmount.toFixed(3)),
                            category: category,
                            charityAddress: charityAddress,
                            donationHash: donation.hash,
                            timestamp: new Date().toISOString(),
                            date: new Date().toLocaleDateString(),
                            time: new Date().toLocaleTimeString()
                        };
                        const spendingKey = `${CHARITY_SPENDING_PREFIX}${charityAddress}`;
                        const existingSpending = getLocalStorage(spendingKey, []);
                        const updatedSpending = [spending, ...existingSpending];
                        setLocalStorage(spendingKey, updatedSpending);
                        
                        newSpendingCount++;
                    }
                });
                
                loadSpendingData();
                
                if (newSpendingCount > 0) {
                    showStatus(`üéâ Found ${newSpendingCount} new spending updates from your donated charities!`, 'success');
                } else {
                    showStatus('‚úÖ All spending data is up to date!', 'success');
                }
            }, 1500);
        }

        function updateSpendingDisplay() {
            const spendingList = document.getElementById('spendingList');
            
            if (donationHistory.length === 0) {
                spendingList.innerHTML = `
                    <div class="no-transactions">
                        üí° <strong>No donations yet!</strong><br>
                        Make your first donation to see how charities use your contributions.
                    </div>
                `;
                document.getElementById('medicalSpending').textContent = '0.0 APT';
                document.getElementById('educationSpending').textContent = '0.0 APT';
                document.getElementById('foodSpending').textContent = '0.0 APT';
                document.getElementById('housingSpending').textContent = '0.0 APT';
                return;
            }
            
            if (charitySpendingData.length === 0) {
                spendingList.innerHTML = `
                    <div class="no-transactions">
                        üìä <strong>Spending data loading...</strong><br>
                        Your donated charities haven't reported spending yet. Click "üîÑ Update" to check for new data.
                    </div>
                `;
                const donatedByCategory = { medical: 0, education: 0, food: 0, housing: 0 };
                donationHistory.forEach(donation => {
                    const amount = parseFloat(donation.amount) / 4;
                    Object.keys(donatedByCategory).forEach(category => {
                        donatedByCategory[category] += amount;
                    });
                });
                
                document.getElementById('medicalSpending').textContent = `${donatedByCategory.medical.toFixed(1)} APT`;
                document.getElementById('educationSpending').textContent = `${donatedByCategory.education.toFixed(1)} APT`;
                document.getElementById('foodSpending').textContent = `${donatedByCategory.food.toFixed(1)} APT`;
                document.getElementById('housingSpending').textContent = `${donatedByCategory.housing.toFixed(1)} APT`;
                return;
            }
            const spendingByCharity = {};
            charitySpendingData.forEach(spending => {
                const address = spending.charityAddress;
                if (!spendingByCharity[address]) {
                    spendingByCharity[address] = [];
                }
                spendingByCharity[address].push(spending);
            });
            let spendingHtml = '';
            Object.keys(spendingByCharity).forEach(address => {
                const shortAddress = `${address.substring(0, 10)}...${address.substring(address.length - 8)}`;
                const charitySpending = spendingByCharity[address];
                const totalSpent = charitySpending.reduce((sum, s) => sum + s.amount, 0);
                const totalDonated = donationHistory
                    .filter(d => d.recipient === address)
                    .reduce((sum, d) => sum + parseFloat(d.amount), 0);

                spendingHtml += `
                    <div style="background: #f8f9fa; padding: 1rem; margin-bottom: 1rem; border-radius: 10px; border-left: 4px solid #007bff;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong>üèõÔ∏è Charity: ${shortAddress}</strong>
                            <small style="color: #666;">You donated: ${totalDonated.toFixed(3)} APT | They spent: ${totalSpent.toFixed(3)} APT</small>
                        </div>
                `;
                
                charitySpending.forEach(spending => {
                    spendingHtml += `
                        <div class="spending-item" style="margin-left: 1rem; margin-bottom: 0.5rem;">
                            <div class="spending-details">
                                <div class="spending-title">${spending.title}</div>
                                <div class="spending-description">${spending.description}</div>
                                <div class="spending-date">${spending.date} at ${spending.time}</div>
                            </div>
                            <div class="spending-cost">-${spending.amount.toFixed(3)} APT</div>
                        </div>
                    `;
                });
                
                spendingHtml += '</div>';
            });

            spendingList.innerHTML = spendingHtml;
            const categories = {
                medical: 0,
                education: 0,
                food: 0,
                housing: 0
            };

            charitySpendingData.forEach(item => {
                if (categories.hasOwnProperty(item.category)) {
                    categories[item.category] += item.amount;
                }
            });

            document.getElementById('medicalSpending').textContent = `${categories.medical.toFixed(1)} APT`;
            document.getElementById('educationSpending').textContent = `${categories.education.toFixed(1)} APT`;
            document.getElementById('foodSpending').textContent = `${categories.food.toFixed(1)} APT`;
            document.getElementById('housingSpending').textContent = `${categories.housing.toFixed(1)} APT`;
        }

        function updateImpactMetrics() {
            const totalDonations = donationHistory.length;
            const totalAmount = donationHistory.reduce((sum, tx) => {
                return sum + (parseFloat(tx.amount) || 0);
            }, 0);
            const livesImpacted = Math.floor(totalAmount * 2.5);
            const projectsFunded = Math.floor(totalAmount / 5);

            document.getElementById('totalDonationsMetric').textContent = totalDonations;
            document.getElementById('totalAmountMetric').textContent = `${totalAmount.toFixed(3)} APT`;
            document.getElementById('livesImpactedMetric').textContent = livesImpacted;
            document.getElementById('projectsFundedMetric').textContent = projectsFunded;
        }

        async function sendTransaction() {
            const recipientAddress = document.getElementById('recipientAddress').value.trim();
            const amountStr = document.getElementById('amount').value.trim();
            if (!recipientAddress || !amountStr) {
                showStatus('Please fill in all fields', 'error');
                return;
            }

            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount <= 0) {
                showStatus('Please enter a valid amount greater than 0', 'error');
                return;
            }

            if (!recipientAddress.startsWith('0x') || recipientAddress.length < 10) {
                showStatus('Please enter a valid wallet address', 'error');
                return;
            }
            if (recipientAddress === '0xd42f5bc06353ac78ccebb345c10bf623b564ad4a9ff8c7fef58447e425f63763') {
                if (!confirm('‚ö†Ô∏è WARNING: You are about to send to a dummy address! This will result in loss of funds. Are you sure you want to continue?')) {
                    return;
                }
            }

            const sendBtn = document.getElementById('sendBtn');
            
            try {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<span class="loading"></span>Sending...';
                showStatus('Preparing transaction...', 'info');
                const amountInOctas = Math.floor(amount * 100000000);

                const transaction = {
                    type: "entry_function_payload",
                    function: "0x1::coin::transfer",
                    type_arguments: ["0x1::aptos_coin::AptosCoin"],
                    arguments: [recipientAddress, amountInOctas.toString()]
                };

                console.log('Submitting transaction:', transaction);

                const pendingTransaction = await window.aptos.signAndSubmitTransaction(transaction);
                
                if (!pendingTransaction || !pendingTransaction.hash) {
                    throw new Error('Transaction submission failed - no hash received');
                }

                console.log('Transaction submitted with hash:', pendingTransaction.hash);
                showStatus('Transaction submitted! Checking confirmation...', 'info');
                const confirmedTx = await waitForTransactionConfirmation(pendingTransaction.hash);
                
                if (confirmedTx.success) {
                    showStatus(`Successfully sent ${amount} APT to charity! Your donation will create real impact. üéâ`, 'success');
                    const transactionRecord = {
                        id: Date.now() + Math.random(),
                        amount: amount,
                        recipient: recipientAddress,
                        hash: pendingTransaction.hash,
                        timestamp: new Date().toISOString(),
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString(),
                        walletAddress: currentAccount.address
                    };
                    
                    donationHistory.unshift(transactionRecord);
                    saveDonationHistory();
                    updateDonationDisplay();
                    updateImpactMetrics();
                    setTimeout(() => {
                        const newSpendingItems = generateSpendingForDonation(transactionRecord);
                        if (newSpendingItems > 0) {
                            showStatus(`üìä Generated ${newSpendingItems} spending records for your donation!`, 'success');
                        }
                    }, 2000);
                    document.getElementById('amount').value = '';
                } else {
                    throw new Error('Transaction failed on blockchain');
                }

            } catch (error) {
                console.error('Transaction error:', error);
                if (error.message.includes('timeout')) {
                    showStatus('Transaction may still be processing. Check your wallet or Aptos Explorer for confirmation.', 'error');
                } else {
                    handleError(error, 'Transaction');
                }
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'Send Donation';
            }
        }

        async function waitForTransactionConfirmation(txHash) {
            const maxAttempts = 60;
            const delayMs = 2000;
            
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                try {
                    console.log(`Checking transaction status (attempt ${attempt}/${maxAttempts})`);
                    
                    const response = await fetch(`${APTOS_NODE_URL}/transactions/by_hash/${txHash}`);
                    
                    if (response.ok) {
                        const tx = await response.json();
                        console.log('Transaction status:', tx);
                        
                        if (tx.success === true) {
                            console.log('Transaction confirmed successfully!');
                            return tx;
                        } else if (tx.success === false) {
                            throw new Error(`Transaction failed: ${tx.vm_status || 'Unknown error'}`);
                        }
                    } else if (response.status !== 404) {
                        console.warn(`API error (attempt ${attempt}):`, response.status, response.statusText);
                    }
                } catch (fetchError) {
                    console.log(`Fetch error (attempt ${attempt}):`, fetchError.message);
                }
                const remaining = maxAttempts - attempt;
                if (remaining > 0) {
                    showStatus(`Waiting for confirmation... (${remaining} attempts remaining)`, 'info');
                    await new Promise(resolve => setTimeout(resolve, delayMs));
                }
            }
            
            throw new Error('Transaction confirmation timeout. Transaction may still be processing.');
        }

        function saveDonationHistory() {
            if (currentAccount && currentAccount.address) {
                try {
                    const key = `${STORAGE_PREFIX}${currentAccount.address}`;
                    const success = setLocalStorage(key, donationHistory);
                    
                    if (success) {
                        updateGlobalStats();
                        showStatus('üíæ Donation history saved permanently!', 'success');
                    }
                } catch (error) {
                    console.warn('Could not save donation history:', error);
                    showStatus('Warning: Could not save donation history permanently.', 'error');
                }
            }
        }

        function loadDonationHistory() {
            if (currentAccount && currentAccount.address) {
                try {
                    const key = `${STORAGE_PREFIX}${currentAccount.address}`;
                    const savedHistory = getLocalStorage(key, []);
                    donationHistory = Array.isArray(savedHistory) ? savedHistory : [];
                    
                    console.log(`Loaded ${donationHistory.length} donation records from localStorage`);
                    
                    if (donationHistory.length > 0) {
                        showStatus(`‚úÖ Loaded ${donationHistory.length} saved donation records!`, 'success');
                    }
                } catch (error) {
                    console.warn('Could not load donation history:', error);
                    donationHistory = [];
                }
            }
        }

        function updateGlobalStats() {
            try {
                const totalAmount = donationHistory.reduce((sum, tx) => sum + (parseFloat(tx.amount) || 0), 0);
                const stats = {
                    lastUpdated: new Date().toISOString(),
                    totalDonations: donationHistory.length,
                    totalAmount: totalAmount,
                    walletAddress: currentAccount.address
                };
                setLocalStorage(GLOBAL_STATS_KEY, stats);
            } catch (error) {
                console.warn('Could not update global stats:', error);
            }
        }

        function exportHistory() {
            if (donationHistory.length === 0) {
                showStatus('No donation history to export.', 'info');
                return;
            }

            try {
                const exportData = {
                    walletAddress: currentAccount.address,
                    exportDate: new Date().toISOString(),
                    totalDonations: donationHistory.length,
                    totalAmount: donationHistory.reduce((sum, tx) => sum + (parseFloat(tx.amount) || 0), 0),
                    donations: donationHistory,
                    version: '1.0'
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `charity-donations-${currentAccount.address.slice(0, 8)}-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('‚úÖ Donation history exported successfully!', 'success');
            } catch (error) {
                handleError(error, 'Export history');
            }
        }

        function importHistory(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    if (!importData.donations || !Array.isArray(importData.donations)) {
                        throw new Error('Invalid import file format');
                    }
                    const merge = confirm(
                        `Found ${importData.donations.length} donations in import file.\n\n` +
                        `Current history: ${donationHistory.length} donations\n` +
                        `Import from: ${importData.walletAddress || 'Unknown wallet'}\n\n` +
                        `Click OK to MERGE with existing history, or Cancel to REPLACE existing history.`
                    );

                    if (merge) {
                        const existingHashes = new Set(donationHistory.map(tx => tx.hash));
                        const newDonations = importData.donations.filter(tx => 
                            tx.hash && !existingHashes.has(tx.hash)
                        );
                        
                        donationHistory = [...donationHistory, ...newDonations];
                        showStatus(`‚úÖ Merged ${newDonations.length} new donations from import file!`, 'success');
                    } else {
                        donationHistory = importData.donations;
                        showStatus(`‚úÖ Replaced history with ${donationHistory.length} imported donations!`, 'success');
                    }
                    saveDonationHistory();
                    updateDonationDisplay();
                    updateImpactMetrics();

                } catch (error) {
                    handleError(error, 'Import history');
                }
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function updateDonationDisplay() {
            const totalDonatedElement = document.getElementById('totalDonated');
            const transactionListElement = document.getElementById('transactionList');

            if (!totalDonatedElement || !transactionListElement) {
                console.warn('Donation display elements not found');
                return;
            }
            const totalAmount = donationHistory.reduce((sum, tx) => {
                return sum + (parseFloat(tx.amount) || 0);
            }, 0);
            totalDonatedElement.textContent = `Total: ${totalAmount.toFixed(4)} APT`;
            if (donationHistory.length === 0) {
                transactionListElement.innerHTML = `
                    <div class="no-transactions">
                        No donations made yet. Your charity donations will appear here and be saved permanently.
                    </div>
                `;
            } else {
                transactionListElement.innerHTML = donationHistory.map(tx => {
                    const amount = parseFloat(tx.amount) || 0;
                    const recipient = tx.recipient || 'Unknown';
                    const shortRecipient = recipient.length > 18 ? 
                        `${recipient.substring(0, 10)}...${recipient.substring(recipient.length - 8)}` : 
                        recipient;
                    const hash = tx.hash || '';
                    const shortHash = hash.length > 8 ? `${hash.substring(0, 8)}...` : hash;
                    
                    return `
                        <div class="transaction-item">
                            <div class="transaction-details">
                                <div class="transaction-amount">+${amount.toFixed(4)} APT</div>
                                <div class="transaction-address">To: ${shortRecipient}</div>
                                <div class="transaction-time">${tx.date || 'Unknown date'} at ${tx.time || 'Unknown time'}</div>
                            </div>
                            <div class="transaction-hash" onclick="viewTransaction('${hash}')" title="View on Aptos Explorer">
                                ${shortHash}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function viewTransaction(hash) {
            if (hash) {
                const explorerUrl = `https://explorer.aptoslabs.com/txn/${hash}?network=testnet`;
                window.open(explorerUrl, '_blank');
            }
        }

        function clearHistory() {
            if (donationHistory.length === 0) {
                showStatus('No donation history to clear.', 'info');
                return;
            }

            const totalAmount = donationHistory.reduce((sum, tx) => sum + (parseFloat(tx.amount) || 0), 0);
            
            if (confirm(
                `‚ö†Ô∏è Are you sure you want to permanently delete your donation history?\n\n` +
                `This will remove:\n` +
                `‚Ä¢ ${donationHistory.length} donation records\n` +
                `‚Ä¢ Total of ${totalAmount.toFixed(4)} APT donated\n\n` +
                `This action cannot be undone!`
            )) {
                try {
                    donationHistory = [];
                    if (currentAccount && currentAccount.address) {
                        const key = `${STORAGE_PREFIX}${currentAccount.address}`;
                        removeLocalStorage(key);
                    }
                    
                    updateDonationDisplay();
                    updateImpactMetrics();
                    showStatus('üóëÔ∏è Donation history permanently cleared', 'info');
                } catch (error) {
                    handleError(error, 'Clear history');
                }
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            if (!statusDiv) return;
            
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');

            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            } else if (type === 'info') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 4000);
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            initializeStorage();
            const donationForm = document.getElementById('donationForm');
            if (donationForm) {
                donationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    sendTransaction();
                });
            }
            loadSpendingData();
            if (isLocalStorageAvailable()) {
                console.log('‚úÖ localStorage is available - donations will persist');
            } else {
                console.warn('‚ùå localStorage is not available - donations will not persist');
            }
        });
        window.addEventListener('load', async function() {
            try {
                if (window.aptos && window.aptos.account) {
                    const account = await window.aptos.account();
                    if (account && account.address) {
                        currentAccount = account;
                        document.getElementById('walletAddress').textContent = currentAccount.address;
                        document.getElementById('connectSection').classList.add('hidden');
                        document.getElementById('walletSection').classList.remove('hidden');
                        loadDonationHistory();
                        updateDonationDisplay();
                        updateImpactMetrics();
                        loadSpendingData();
                        showStatus('Wallet reconnected automatically!', 'success');
                    }
                }
            } catch (error) {
                console.log('Wallet not previously connected');
            }
        });
        if (window.aptos && window.aptos.onAccountChange) {
            try {
                window.aptos.onAccountChange((account) => {
                    if (account && account.address) {
                        if (currentAccount) {
                            saveDonationHistory();
                        }
                        
                        currentAccount = account;
                        document.getElementById('walletAddress').textContent = currentAccount.address;
                        loadDonationHistory();
                        updateDonationDisplay();
                        updateImpactMetrics();
                        showStatus(`Switched to wallet: ${account.address.slice(0, 10)}...`, 'info');
                    } else {
                        disconnectWallet();
                    }
                });
            } catch (error) {
                console.warn('Account change listener not available:', error);
            }
        }
        setInterval(() => {
            if (currentAccount && donationHistory.length > 0) {
                const key = `${STORAGE_PREFIX}${currentAccount.address}`;
                const currentSaved = getLocalStorage(key, []);
                if (JSON.stringify(currentSaved) !== JSON.stringify(donationHistory)) {
                    console.log('Auto-saving donation history...');
                    saveDonationHistory();
                }
            }
        }, 30000);
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden' && currentAccount && donationHistory.length > 0) {
                console.log('Page hidden - saving donation history...');
                saveDonationHistory();
            }
        });
        window.addEventListener('beforeunload', function() {
            if (currentAccount && donationHistory.length > 0) {
                saveDonationHistory();
            }
        });
    </script>
</body>
</html>
